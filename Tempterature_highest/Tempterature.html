<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>世界地图</title>
    <!-- 引入 echarts.js 和 papaparse.js -->
    <script src="https://cdn.staticfile.org/echarts/4.3.0/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>

<body>
    <!-- 为ECharts准备一个具备大小（宽高）的Dom -->
    <div id="main" style="width: 1500px; height: 800px;"></div>
    <div id="lineChart" style="width: 1500px; height: 700px;"></div>
    <button id="toggleData">切换数据</button>
    <script type="text/javascript">
        var myChart = echarts.init(document.getElementById('main'));
        var lineChart = echarts.init(document.getElementById('lineChart'));
        var globalData = {};

        // 函数：设置图表
        function setupChart(data) {
            fetch('../Data/world.geojson')
                .then(response => response.json())
                .then(geoJson => {
                    echarts.registerMap('world', geoJson);

                    // 创建时间轴数据
                    var years = Object.keys(data);

                    // 设置 ECharts 配置项
                    var option = {
                        baseOption: {
                            timeline: {
                                axisType: 'category',
                                autoPlay: true,
                                playInterval: 1000,
                                data: years,
                                label: {
                                    formatter: function (s) {
                                        return s;
                                    }
                                },
                                animation: false // Disable timeline animation

                            },
                            tooltip: {
                                trigger: 'item',
                                formatter: function (params) {
                                    return `Year: ${params.data.name}<br/>Temperature: ${params.data.value[2]}`;
                                }
                            },
                            visualMap: {
                                min: -10,
                                max: 30,
                                calculable: true,
                                inRange: {
                                    color: ['blue', 'green', 'yellow', 'red']
                                },
                                textStyle: {
                                    color: '#000'
                                }
                            },
                            geo: {
                                map: 'world',
                                roam: false,
                                label: {
                                    emphasis: {
                                        show: false
                                    }
                                },
                                itemStyle: {
                                    normal: {
                                        areaColor: '#323c48',
                                        borderColor: '#111'
                                    },
                                    emphasis: {
                                        areaColor: '#2a333d'
                                    }
                                }
                            },
                            series: [{
                                name: 'Temperature',
                                type: 'scatter',
                                coordinateSystem: 'geo',
                                symbolSize: function (val) {
                                    return 30;
                                },
                                data: [],
                                itemStyle: {
                                    normal: {
                                        opacity: 0.2 // 设置透明度
                                    }
                                }
                            }]
                        },
                        options: []
                    };

                    // 创建每一年的数据选项
                    years.forEach(function (year) {
                        var scatterData = data[year].map(item => ({
                            name: year,
                            value: [item.longitude, item.latitude, item.temperature]
                        }));

                        option.options.push({
                            series: [{
                                data: scatterData
                            }]
                        });
                    });

                    // 初始化图表
                    myChart.setOption(option);
                })
                .catch(error => console.error('Error loading geojson file:', error));
        }

        // 加载单个年份数据的函数
        function loadSingleYearData(year, callback) {
            var file = `./data/${year}.csv`;
            Papa.parse(file, {
                download: true,
                header: true,
                complete: function (results) {
                    globalData[year] = results.data.map(item => ({
                        station: item.station,
                        latitude: parseFloat(item.latitute),  // 注意：如果是 'latitude'，则改为 'latitude'
                        longitude: parseFloat(item.longitude),
                        elevation: parseFloat(item.elevation),
                        temperature: parseFloat(item.T_max)
                    }));
                    callback();
                }
            });
        }

        // 加载多个年份数据的函数
        function loadData(callback) {
            var startYear = 2000;
            var endYear = 2019;
            var loadedCount = 0;

            for (var year = startYear; year <= endYear; year++) {
                loadSingleYearData(year, function () {
                    loadedCount++;
                    if (loadedCount === endYear - startYear + 1) {
                        callback();
                    }
                });
            }
        }

        // 读取所有数据并初始化图表
        loadData(function () {
            console.log(globalData);
            // 确保所有数据加载完毕后再进行图表初始化
            setupChart(globalData);
        });
    </script>
</body>

</html>
