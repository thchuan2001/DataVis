<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>World Map - Economic and Environmental Data Visualization</title>
    <script src="https://cdn.staticfile.org/echarts/4.3.0/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        .header {
            display: flex; /* Enables flexbox layout */
            align-items: center; /* Vertically center the items */
            justify-content: space-between; /* Space between the title and the button */
            margin-bottom: 20px; /* Margin below the header */
        }

        button {
            background-color: #4CAF50; /* Green background */
            border: none; /* No borders */
            color: white; /* White text */
            padding: 10px 20px; /* Smaller padding */
            text-align: center;
            text-decoration: none;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.3s ease;
        }

        button:hover {
            background-color: #45a049; /* Darker shade on hover */
        }

        h1 {
            margin: 0; /* Removes default margin */
            padding: 0; /* Removes default padding */
        }
    </style>
</head>
<body>

    <div class="header">
    <h1>World Map - Economic and Environmental Data Visualization</h1>
    <button id="toggleData">Change Data</button>
    </div>

    <div id="main" style="width: 1000px; height: 600px;"></div>
    <div id="lineChart" style="width: 1000px; height: 400px;"></div>



    <script type="text/javascript">
        var myChart = echarts.init(document.getElementById('main'));
        var lineChart = echarts.init(document.getElementById('lineChart'));
        var globalData = {};
        var currentDataset = 'CO2';

        function loadData(file, key, callback) {
            Papa.parse(file, {
                download: true,
                header: true,
                complete: function (results) {
                    globalData[key] = results.data;
                    callback(results.data);
                }
            });
        }

        function findMinMax(data, years, countries) {
            let min = Infinity, max = -Infinity;
            data.forEach(item => {
                if (countries.includes(item['Country Name'])) {
                    years.forEach(year => {
                        let value = parseFloat(item[year]);
                        if (value) {
                            if (value < min) min = value;
                            if (value > max) max = value;
                        }
                    });
                }
            });
            return { min, max };
        }

        function setupChart(data, titleSuffix, colorScheme) {
            fetch('./Data/world.geojson').then(response => response.json()).then(geoJson => {
                echarts.registerMap('world', geoJson);
                var countries = geoJson.features.map(feature => feature.properties.name);
                var years = Object.keys(data[0]).filter(key => key !== 'Country Name');
                var filteredData = data.filter(item => countries.includes(item['Country Name']));

                filteredData.forEach(item => {
                    years.forEach(year => {
                        item[year] = Math.sqrt(parseFloat(item[year]) + 1);
                    });
                });

                var { min, max } = findMinMax(filteredData, years, countries);

                var options = years.map(year => ({
                    title: { text: year + ' ' + titleSuffix },
                    series: [{ data: filteredData.map(item => ({ name: item['Country Name'], value: parseFloat(item[year]) })) }]
                }));

                myChart.setOption({
                    baseOption: {
                        timeline: {
                            axisType: 'category',
                            autoPlay: false,
                            playInterval: 600,
                            data: years,
                            tooltip: {
                                formatter: function (params) {
                                    return params.name;
                                }
                            }
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: '{b}: {c}'
                        },
                        visualMap: {
                            min: min,
                            max: max,
                            left: 'right',
                            top: 'bottom',
                            text: ['High', 'Low'],
                            calculable: true,
                            inRange: {
                                color: colorScheme
                            }
                        },
                        series: [{
                            type: 'map',
                            mapType: 'world',
                            roam: true,
                            itemStyle: {
                                borderColor: '#FFF',
                                borderWidth: 1
                            },
                            emphasis: {
                                itemStyle: {
                                    borderColor: '#000',
                                    borderWidth: 3
                                },
                                label: {
                                    show: true,
                                    position: 'inside',
                                    fontSize: 10,
                                    fontWeight: 'bold'
                                }
                            }
                        }]
                    },
                    options: options
                });

                myChart.on('click', function (params) {
                    if (params.componentType === 'series') {
                        updateLineChart(params.name);
                    }
                });
            }).catch(error => console.error('Error loading geojson file:', error));
        }

        function updateLineChart(countryName) {
    var co2Data = globalData['CO2'].find(item => item['Country Name'] === countryName);
    var gdpData = globalData['GDP'].find(item => item['Country Name'] === countryName);
    var years = Object.keys(co2Data).filter(key => key !== 'Country Name');

    var co2SeriesData = years.map(year => parseFloat(co2Data[year]));
    var gdpSeriesData = years.map(year => parseFloat(gdpData[year]));

    // Calculate min and max for CO2
    var co2Min = Math.min(...co2SeriesData);
    var co2Max = Math.max(...co2SeriesData);

    // Calculate min and max for GDP
    var gdpMin = Math.min(...gdpSeriesData);
    var gdpMax = Math.max(...gdpSeriesData);

    lineChart.setOption({
        title: {
            text: 'GDP and CO2 Over Time - ' + countryName
        },
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['CO2', 'GDP']
        },
        xAxis: {
            type: 'category',
            data: years
        },
        yAxis: [
            {
                type: 'value',
                name: 'CO2 Emissions',
                position: 'left',
                axisLabel: {
                    formatter: '{value} mt'
                },
                min: co2Min,
                max: co2Max
            },
            {
                type: 'value',
                name: 'GDP',
                position: 'right',
                axisLabel: {
                    formatter: '${value} trillion'
                },
                min: gdpMin,
                max: gdpMax
            }
        ],
        series: [
            {
                name: 'CO2',
                type: 'line',
                yAxisIndex: 0,
                data: co2SeriesData,
                lineStyle: {
                    color: '#C33734'  // Red color for CO2
                }
            },
            {
                name: 'GDP',
                type: 'line',
                yAxisIndex: 1,
                data: gdpSeriesData,
                lineStyle: {
                    color: '#fcbe32'  // Blue color for GDP
                }
            }
        ]
    });
}




        loadData('Data/CO2_GDP/CO2.csv', 'CO2', function(data) {
            setupChart(data, 'Carbon Dioxide Emissions (Square Root)', ['#5A99D3', '#C33734']);
            // Ensure both datasets are loaded initially
            loadData('Data/CO2_GDP/GDP.csv', 'GDP', function(data) {});
        });

        document.getElementById('toggleData').addEventListener('click', function () {
            if (currentDataset === 'CO2') {
                setupChart(globalData['GDP'], 'GDP (Square Root)', ['#2F4858', '#FFEF87']);
                currentDataset = 'GDP';
            } else {
                setupChart(globalData['CO2'], 'Carbon Dioxide Emissions (Square Root)', ['#5A99D3', '#C33734']);
                currentDataset = 'CO2';
            }
        });
    </script>
</body>
</html>
