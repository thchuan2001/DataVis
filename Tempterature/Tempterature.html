<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>世界地图气温热力图</title>
    <!-- 引入 echarts.js -->
    <script src="https://cdn.staticfile.org/echarts/4.3.0/echarts.min.js"></script>
    <!-- 引入 echarts-gl.js -->
    <script src="https://cdn.staticfile.org/echarts-gl/1.1.1/echarts-gl.min.js"></script>
    <!-- 引入 PapaParse.js，用于解析 CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <!-- 为ECharts准备一个具备大小（宽高）的Dom -->
    <div id="main" style="width: 2000px; height: 1000px;"></div>
    <script type="text/javascript">
        // 初始化 ECharts 实例
        var myChart = echarts.init(document.getElementById('main'));
        var globalData = {};

        // 加载 CSV 数据的函数
        function loadData(file, key, callback) {
            Papa.parse(file, {
                download: true,
                header: true,
                complete: function (results) {
                    globalData[key] = results.data;
                    callback(results.data);
                }
            });
        }

        // 加载 world.geojson 文件
        fetch('../Data/world.geojson')
            .then(response => response.json())
            .then(geoJson => {
                // 注册地图
                echarts.registerMap('world', geoJson);

                // 加载 CSV 文件并解析
                loadData('../Data/temperature_data.csv', 'temperature', function(data) {
                    var temperatureData = data.map(function(d) {
                        var longitude = parseFloat(d.longitude);
                        var latitude = parseFloat(d.latitute);
                        var temperature = parseFloat(d['2020']);

                        if (!isNaN(longitude) && !isNaN(latitude) && !isNaN(temperature)) {
                            return [longitude, latitude, temperature];
                        }
                    }).filter(item => item);

                    // 指定图表的配置项和数据
                    var option = {
                        title: {
                            text: '世界地图 - 气温热力图',
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: function (params) {
                                return `Temperature: ${params.value[2].toFixed(2)}°C`;
                            }
                        },
                        visualMap: {
                            min: -20,
                            max: 40,
                            left: 'left',
                            top: 'bottom',
                            text: ['高', '低'],
                            calculable: true,
                            inRange: {
                                color: ['blue', 'green', 'yellow', 'red']
                            }
                        },
                        geo: {
                            map: 'world',
                            roam: true,
                            label: {
                                show: false
                            },
                            itemStyle: {
                                areaColor: '#323c48',
                                borderColor: '#111'
                            }
                        },
                        series: [
                            {
                                name: '气温数据',
                                type: 'heatmap',
                                coordinateSystem: 'geo',
                                data: temperatureData
                            }
                        ]
                    };

                    // 使用刚指定的配置项和数据显示图表
                    myChart.setOption(option);
                });
            })
            .catch(error => {
                console.error('Error loading geojson file:', error);
            });
    </script>
</body>
</html>
